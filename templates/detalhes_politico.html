{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ politico.nome }} - IIP{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <!-- Botão Voltar -->
    <div class="mb-6">
        <a href="{% url 'home' %}" class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
            </svg>
            Voltar para Home
        </a>
    </div>

    <!-- Card Principal do Político -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-8 text-white">
            <div class="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                <!-- Avatar -->
                <div class="flex-shrink-0">
                    {% if politico.foto %}
                        <img src="{{ politico.foto.url }}" alt="{{ politico.nome }}" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg">
                    {% elif politico.foto_url %}
                        <img src="{{ politico.foto_url }}" alt="{{ politico.nome }}" 
                             class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="w-32 h-32 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-3xl border-4 border-white shadow-lg" style="display: none;">
                            {{ politico.nome|get_initials }}
                        </div>
                    {% else %}
                        <div class="w-32 h-32 bg-white/20 rounded-full flex items-center justify-center text-white font-bold text-3xl border-4 border-white shadow-lg">
                            {{ politico.nome|get_initials }}
                        </div>
                    {% endif %}
                </div>
                
                <!-- Informações Básicas -->
                <div class="text-center md:text-left flex-1">
                    <h1 class="text-3xl md:text-4xl font-bold mb-2">{{ politico.nome }}</h1>
                    <div class="space-y-2">
                        {% if politico.cargo %}
                        <p class="text-xl opacity-90 flex items-center justify-center md:justify-start">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zM4 8v8h12V8H4z" clip-rule="evenodd"></path>
                            </svg>
                            {{ politico.cargo.nome }}
                        </p>
                        {% endif %}
                        {% if politico.partido %}
                        <p class="text-lg opacity-90 flex items-center justify-center md:justify-start">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z" clip-rule="evenodd"></path>
                            </svg>
                            {{ politico.partido.sigla }} - {{ politico.partido.nome }}
                        </p>
                        {% endif %}
                        {% if politico.uf or politico.municipio %}
                        <p class="text-lg opacity-90 flex items-center justify-center md:justify-start">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            {% if politico.municipio %}{{ politico.municipio }}{% endif %}{% if politico.municipio and politico.uf %}, {% endif %}{% if politico.uf %}{{ politico.uf }}{% endif %}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Área de Avaliações -->
        <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                </svg>
                Sistema de Avaliação
            </h2>
            
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Notas Atuais -->
                <div class="space-y-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Avaliações Atuais</h3>
                    
                    <!-- Nota Final -->
                    {% if nota_final %}
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-lg border border-yellow-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-700">Nota Final</span>
                            <span class="text-2xl font-bold text-yellow-600">{{ nota_final|floatformat:1 }}/10</span>
                        </div>
                        <div class="flex items-center">
                            {% for i in "0123456789" %}
                                {% if forloop.counter0 < nota_final|floatformat:0|add:0 %}
                                    <svg class="w-5 h-5 text-yellow-400 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% else %}
                                    <svg class="w-5 h-5 text-gray-300 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Combinação de avaliações dos usuários e análise da IA</p>
                    </div>
                    {% endif %}
                    
                    <!-- Nota dos Usuários -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-700">Avaliação dos Usuários (50%)</span>
                            <span class="text-xl font-bold text-blue-600">
                                {% if media_usuarios %}{{ media_usuarios|floatformat:1 }}/10{% else %}N/A{% endif %}
                            </span>
                        </div>
                        {% if media_usuarios %}
                        <div class="flex items-center mb-2">
                            {% for i in "0123456789" %}
                                {% if forloop.counter0 < media_usuarios|floatformat:0|add:0 %}
                                    <svg class="w-4 h-4 text-blue-400 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% else %}
                                    <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        <p class="text-sm text-gray-600">{{ total_avaliacoes }} avaliação{{ total_avaliacoes|pluralize:"ões" }}</p>
                    </div>
                    
                    <!-- Nota da IA -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-gray-700">Análise da IA (50%)</span>
                            <span class="text-xl font-bold text-purple-600">
                                {% if nota_ia %}{{ nota_ia|floatformat:1 }}/10{% else %}N/A{% endif %}
                            </span>
                        </div>
                        {% if nota_ia %}
                        <div class="flex items-center mb-2">
                            {% for i in "0123456789" %}
                                {% if forloop.counter0 < nota_ia|floatformat:0|add:0 %}
                                    <svg class="w-4 h-4 text-purple-400 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% else %}
                                    <svg class="w-4 h-4 text-gray-300 fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        <p class="text-sm text-gray-600">Baseada em dados oficiais e análise de sentimento</p>
                    </div>
                </div>
                
                <!-- Formulário de Avaliação -->
                <div>
                    {% if user.is_authenticated %}
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Sua Avaliação</h3>
                    
                    <form id="avaliacaoForm" class="space-y-4">
                        {% csrf_token %}
                        
                        <!-- Seletor de Estrelas -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nota (1-10 estrelas)</label>
                            <div class="flex items-center space-x-1" id="starRating">
                                {% for i in "0123456789" %}
                                <button type="button" class="star-btn focus:outline-none" data-rating="{{ forloop.counter }}">
                                    <svg class="w-8 h-8 text-gray-300 hover:text-yellow-400 transition-colors fill-current" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </button>
                                {% endfor %}
                            </div>
                            <input type="hidden" id="notaInput" name="nota" value="{% if avaliacao_usuario %}{{ avaliacao_usuario.nota }}{% endif %}">
                        </div>
                        
                        <!-- Comentário -->
                        <div>
                            <label for="comentario" class="block text-sm font-medium text-gray-700 mb-2">Comentário (opcional)</label>
                            <textarea id="comentario" name="comentario" rows="3" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Compartilhe sua opinião sobre este político...">{% if avaliacao_usuario %}{{ avaliacao_usuario.comentario }}{% endif %}</textarea>
                        </div>
                        
                        <!-- Botão Enviar -->
                        <button type="submit" id="submitBtn" 
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            {% if avaliacao_usuario %}Atualizar Avaliação{% else %}Enviar Avaliação{% endif %}
                        </button>
                    </form>
                    
                    <!-- Mensagens -->
                    <div id="mensagem" class="mt-4 hidden"></div>
                    
                    {% else %}
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 text-center">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                        </svg>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Faça login para avaliar</h3>
                        <p class="text-gray-600 mb-4">Você precisa estar logado para avaliar este político.</p>
                        <a href="{% url 'account_login' %}" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors">
                            Fazer Login
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const starButtons = document.querySelectorAll('.star-btn');
    const notaInput = document.getElementById('notaInput');
    const form = document.getElementById('avaliacaoForm');
    const mensagemDiv = document.getElementById('mensagem');
    
    let currentRating = {% if avaliacao_usuario %}{{ avaliacao_usuario.nota }}{% else %}0{% endif %};
    
    // Inicializar estrelas com avaliação existente
    updateStars(currentRating);
    
    // Event listeners para as estrelas
    starButtons.forEach((btn, index) => {
        btn.addEventListener('click', function() {
            currentRating = index + 1;
            notaInput.value = currentRating;
            updateStars(currentRating);
        });
        
        btn.addEventListener('mouseenter', function() {
            updateStars(index + 1, true);
        });
    });
    
    // Restaurar estrelas ao sair do hover
    document.getElementById('starRating').addEventListener('mouseleave', function() {
        updateStars(currentRating);
    });
    
    // Função para atualizar visual das estrelas
    function updateStars(rating, isHover = false) {
        starButtons.forEach((btn, index) => {
            const star = btn.querySelector('svg');
            if (index < rating) {
                star.classList.remove('text-gray-300');
                star.classList.add('text-yellow-400');
            } else {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-300');
            }
        });
    }
    
    // Submit do formulário
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (currentRating === 0) {
                showMessage('Por favor, selecione uma nota de 1 a 10 estrelas.', 'error');
                return;
            }
            
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            fetch('{% url "avaliar_politico" politico.slug %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage(data.message, 'success');
                    // Atualizar estatísticas na página
                    if (data.media_usuarios) {
                        // Aqui você pode atualizar os elementos da página com as novas estatísticas
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    }
                } else {
                    showMessage(data.error || 'Erro ao salvar avaliação', 'error');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                showMessage('Erro de conexão. Tente novamente.', 'error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = '{% if avaliacao_usuario %}Atualizar Avaliação{% else %}Enviar Avaliação{% endif %}';
            });
        });
    }
    
    function showMessage(message, type) {
        mensagemDiv.className = `mt-4 p-4 rounded-md ${type === 'success' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800'}`;
        mensagemDiv.textContent = message;
        mensagemDiv.classList.remove('hidden');
        
        setTimeout(() => {
            mensagemDiv.classList.add('hidden');
        }, 5000);
    }
});
</script>
{% endblock %}